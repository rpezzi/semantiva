{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://semantiva.ai/schemas/ser/0/ser_v0.schema.json",
  "title": "Semantiva Step Evidence Record v0 (draft)",
  "type": "object",
  "required": [
    "type",
    "schema_version",
    "ids",
    "topology",
    "action",
    "io_delta",
    "checks",
    "timing",
    "status"
  ],
  "properties": {
    "type": {"const": "ser"},
    "schema_version": {"const": 0},
    "ids": {
      "type": "object",
      "required": ["run_id", "pipeline_id", "node_id"],
      "additionalProperties": true
    },
    "topology": {
      "type": "object",
      "properties": {
        "upstream": {"type": "array", "items": {"type": "string"}}
      },
      "required": ["upstream"],
      "additionalProperties": true
    },
    "action": {
      "type": "object",
      "required": ["op_ref", "params", "param_source"],
      "properties": {
        "op_ref": {"type": "string"},
        "params": {"type": "object"},
        "param_source": {"type": "object"}
      },
      "additionalProperties": true
    },
    "io_delta": {"type": "object"},
    "checks": {
      "type": "object",
      "required": ["why_run", "why_ok"],
      "properties": {
        "why_run": {
          "type": "object",
          "required": ["trigger", "upstream_evidence", "pre", "policy"],
          "properties": {
            "trigger": {"type": "string"},
            "upstream_evidence": {"type": "array", "items": {"type": "object"}},
            "pre": {
              "type": "array",
              "items": {"$ref": "#/$defs/check"},
              "minItems": 1
            },
            "policy": {"type": "array"}
          },
          "additionalProperties": true
        },
        "why_ok": {
          "type": "object",
          "required": ["post", "invariants", "env", "redaction"],
          "properties": {
            "post": {
              "type": "array",
              "items": {"$ref": "#/$defs/check"},
              "minItems": 1
            },
            "invariants": {"type": "array"},
            "env": {
              "type": "object",
              "required": ["python", "platform", "semantiva"],
              "additionalProperties": {"type": ["string", "null"]}
            },
            "redaction": {"type": "object"}
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "timing": {
      "type": "object",
      "required": ["start", "end", "duration_ms", "cpu_ms"],
      "properties": {
        "start": {"type": "string"},
        "end": {"type": "string"},
        "duration_ms": {"type": "integer"},
        "cpu_ms": {"type": "integer"}
      }
    },
    "status": {"enum": ["completed", "error"]},
    "error": {"type": "object"},
    "labels": {"type": "object"},
    "summaries": {"type": "object"}
  },
  "additionalProperties": true,
  "$defs": {
    "check": {
      "type": "object",
      "required": ["code", "result"],
      "properties": {
        "code": {"type": "string"},
        "result": {"enum": ["PASS", "FAIL", "WARN"]},
        "details": {"type": ["object", "null"]}
      },
      "additionalProperties": true
    }
  }
}
